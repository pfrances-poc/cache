name: PR Validation

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

jobs:
  # Validation rapide pour les PRs (pas de build Docker)
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint

      - name: Run tests
        run: npm run test

      - name: Run build check
        run: npm run build

      - name: Docker build test (sans push)
        run: |
          echo "🔍 Test de build Docker (validation seulement)"
          docker build -t cache-test:pr-${{ github.event.number }} .
          echo "✅ Build Docker réussi"

      - name: Comment PR
        uses: actions/github-script@v7
        if: github.event.action == 'opened'
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `🚀 **PR Validation Completed**

              Cette PR a été validée avec succès !

              ℹ️ **Note importante**: L'image Docker ne sera construite et poussée que lors du merge via le merge group.

              **Validations effectuées:**
              - ✅ Tests unitaires
              - ✅ Linting
              - ✅ Build de l'application
              - ✅ Test de build Docker (sans push)

              **Prochaines étapes:**
              1. Une fois approuvée, cette PR sera ajoutée au merge queue
              2. Le merge group effectuera le build et push final de l'image Docker
              3. L'image sera disponible dans le registry après le merge`
            })
